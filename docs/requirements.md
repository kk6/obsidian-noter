# 要件定義書

## 1. 概要

### 1.1. プロジェクトの目的
このプロジェクトは、ウェブ記事やチャットの会話内容を効率的に要約し、知識管理ツールであるObsidianで活用しやすい形式で整理・保存することを目的とする。ユーザーはClaude AIなどのMCPクライアントを通じて自然言語による簡単な指示で、情報収集と整理のプロセスを自動化できる。

### 1.2. 背景
情報過多の現代において、ウェブ記事やチャットでの議論から重要な情報を抽出し、整理・蓄積することは重要だが、手間のかかる作業である。特にObsidianユーザーにとって、外部情報をMarkdown形式でスムーズに取り込み、メタデータと共に管理する仕組みが求められている。

### 1.3. スコープ

#### 1.3.1. 対象機能
- ウェブ記事（URLまたはテキスト）の要約機能
- チャット会話履歴（テキスト）の要約機能
- 要約結果のObsidian Markdown形式（YAMLフロントマター含む）での出力
- 基本的なルールベース要約機能（APIキー不要）
- (オプション) Anthropic/OpenAI API連携による高度な要約機能
- ユーザーによるファイル名指定オプション
- ユーザーによる要約粒度（長さ、形式）の指定オプション（基本的な指示レベル）

#### 1.3.2. 対象外機能 (将来的な拡張候補)
- PDF、Word文書など、テキスト/URL以外の入力形式の直接サポート
- チャット要約における感情分析、アクションアイテム自動抽出、参加者別分析
- 複数記事/チャットの一括処理
- Obsidianへの直接保存（現在はMarkdown生成まで）
- 過去のチャット履歴への自動アクセス

## 2. 機能要件

### 2.1. 記事要約機能 (`summarize_to_obsidian`)
- **入力**:
    - ウェブ記事のURL (HTTP/HTTPS)
    - 記事の全文テキスト
    - (オプション) 希望する出力ファイル名
    - (オプション) 要約の粒度に関する指示（例：「3段落で」、「要点だけ」）
- **処理**:
    - URLの場合、ウェブページから本文コンテンツを抽出する（ノイズ除去含む）。
    - テキストを分析し、要約を生成する（デフォルトはルールベース、APIキー設定時はAPI利用）。
    - ルールベース要約: 重要な文（例：最初/最後、キーワード含む、見出し直下）を抽出・構成する。
    - API連携要約: 設定されたAPI（Anthropic/OpenAI）を利用し、文脈を理解した要約を生成する。
    - 指定されたファイル名があれば使用し、なければ記事タイトル等から推測する。
- **出力**:
    - Obsidian互換のMarkdown形式テキスト。
    - YAMLフロントマター（title, date, source_url, tagsなど）を含む。
    - 要約本文（見出し、箇条書き等で構造化）。
    - フッター情報（元のソースURL、要約日など）。
- **インターフェース**:
    - Claude AI等から自然言語で呼び出し可能（例：「この記事を要約してObsidianに保存してください: [URL/テキスト]」）。

### 2.2. チャット要約機能 (`summarize_chat_to_obsidian`)
- **入力**:
    - チャット会話履歴のテキスト。
    - (オプション) 希望する出力ファイル名。
    - (オプション) 要約の粒度に関する指示（例：「箇条書きで」、「結論だけ」）。
- **処理**:
    - チャット履歴テキストを解析する。
    - 主要なトピック、議論のポイント、決定事項などを抽出する（デフォルトはルールベース、APIキー設定時はAPI利用）。
    - ルールベース要約: パターンマッチング等でキーフレーズや発言者を特定し、整理する。
    - API連携要約: 設定されたAPIを利用し、会話の流れを理解した要約を生成する。
    - 指定されたファイル名があれば使用し、なければ「チャット要約: [日付/トピック]」等とする。
- **出力**:
    - Obsidian互換のMarkdown形式テキスト。
    - YAMLフロントマター（title, date, source_type="chat", tagsなど）を含む。
    - 要約本文（トピック、主要ポイント、結論など見出しをつけて構造化）。
    - フッター情報（元のソース、要約日など）。
- **インターフェース**:
    - Claude AI等から自然言語で呼び出し可能（例：「このチャットをまとめてObsidianに保存してください」）。

### 2.3. エラーハンドリング
- 無効なURL、アクセス不能なURL、記事抽出失敗時に適切なエラーメッセージを返すこと。
- チャット解析に失敗した場合にエラーメッセージを返すこと。
- 外部API利用時にエラーが発生した場合（認証エラー、APIエラー等）に、フォールバック（ルールベース要約への切り替えやエラー通知）を行うこと。
- タイムアウト（記事取得、API呼び出し）を適切に処理すること。

## 3. 非機能要件

### 3.1. 使いやすさ (Usability)
- ユーザーは自然言語で直感的に操作できること。
- Claude Desktopとの連携が容易であり、`mcp install` コマンドで簡単にセットアップできること。
- 出力されるMarkdownはObsidianでそのまま利用可能で、可読性が高いこと。

### 3.2. 信頼性 (Reliability)
- 安定して動作し、一般的な利用シナリオでクラッシュしないこと。
- エラー発生時にも、可能な限り有用な情報（エラー原因など）をユーザーに提示すること。

### 3.3. パフォーマンス (Performance)
- 一般的な長さの記事やチャット履歴に対し、数秒〜数十秒程度で応答を返すこと（外部API利用時はその応答時間に依存）。
- 大規模なテキスト入力に対しても、過度にメモリを消費したり、フリーズしたりしないこと（チャンク処理などを考慮）。

### 3.4. 保守性・拡張性 (Maintainability & Extensibility)
- コードはモジュール化され、各コンポーネント（抽出、要約、Markdown変換）が分離されていること (`architecture.md` 参照)。
- コーディング規約（PEP 8, Ruff, mypy, Google Style Docstrings）に従い、コードの可読性と品質を維持すること (`development.md` 参照)。
- ユニットテスト (pytest) が整備され、主要機能がカバーされていること。カバレッジレポートも活用する。
- 将来的に新しい入力形式、要約エンジン、出力形式を追加しやすい設計であること。

### 3.5. セキュリティ
- 外部APIキーは環境変数等を通じて安全に管理されること (`installation.md` 参照)。
- URLアクセス時に意図しないリダイレクトやリソース消費を防ぐ考慮をすること。

## 4. 制約事項

- **開発言語**: Python 3.12以上
- **フレームワーク**: Model Context Protocol (MCP) サーバーとして実装 (FastMCP利用)
- **パッケージ管理**: `uv` (推奨) または `pip` を使用し、依存関係は `pyproject.toml` で管理
- **実行環境**: 主にClaude Desktop環境での利用を想定
- **ライセンス**: MIT License
- **外部依存**:
    - 基本機能は `httpx`, `beautifulsoup4`, `pyyaml` 等に依存。
    - オプション機能は Anthropic/OpenAI の Python ライブラリに依存。
